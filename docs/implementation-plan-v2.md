# マルミエ v2.0 実装計画

## 1. 背景と目的
- 現行 v1 系は CSV 読み込み・リスティング分析・アンケート分析・相関分析まで実装済み。
- 新要件では「ローカル保存機能」「PDF出力機能」を追加し、既存 UI トーンとプライバシーポリシーを維持したまま共有性を高める。
- 提供された CSV サンプル（例: `/Users/YUSUKE/Desktop/リスティング - 内科.csv` ほか）で検証しながら v2.0 を完成させる。

## 2. 開発前提
- 技術基盤: React 18 + Vite + TypeScript、チャートは Recharts、CSV 処理は PapaParse。
- 状態管理: `DataContext` で全データを集中管理。月選択やエラーハンドリングも同コンテキストが担当。
- クライアント完結型の設計を維持し、外部送信や永続ストレージ呼び出しは行わない。
- PDF 生成はブラウザ実行可能なライブラリ（`jsPDF`+`html2canvas` を優先候補、必要に応じて `react-pdf` を比較）。

## 3. 実装フェーズ概要
1. **調査・設計 (1.5日)**
   - 既存データ構造/API の確認、保存対象データの定義、PDF レイアウト草案作成。
   - ライブラリ比較（`jsPDF` vs `react-pdf`）と PoC を軽く実施。
2. **ローカル保存機能 (2日)**
   - データシリアライズと復元ストーリーの実装、UI ボタンとトースト通知の追加。
   - JSON/統合CSV ダウンロード機能、JSON 再読み込みフローを完成。
3. **PDF出力機能 (3日)**
   - 各分析セクションを PDF にレンダリングするレイアウトコンポーネント構築。
   - UI 連携（生成中ステータス、セクション選択、カラー/モノクロ切替）。
4. **最終統合・調整 (1.5日)**
   - パフォーマンス最適化、アクセシビリティ/色覚対応の確認、Help ドキュメント更新。
   - 実データで回帰テスト、バグ修正、リリース準備。

## 4. 詳細タスク

### 4.1 データ保存機能
1. **保存対象定義**
   - `DataContext` の各データ配列、エラー/警告、選択中月を JSON にまとめる。
   - バージョン番号と保存日時をメタ情報として付与。
2. **ダウンロード実装**
   - `utils/exportUtils` (新規) に JSON/CSV 生成ロジックを集約。
   - JSON は `Blob` + `URL.createObjectURL` でダウンロード。
   - 統合 CSV は予約・広告・アンケートを統一カラムに整形し、行ごとに出力。
3. **UI 拡張**
   - `App.tsx` ヘッダーまたはナビに「データ保存」ボタンを配置。
   - モーダルで形式選択 (JSON / CSV)。決定後に処理開始、完了トースト表示。
4. **復元フロー**
   - `FileUpload` へ JSON 受付 UI を追加。復元時は `clearAllData` → 各 setter に投入。
   - バージョン/対象期間を検証し、整合性不一致は警告表示。
5. **ローカルストレージ対応 (オプション)**
   - 直近保存状態を `localStorage` にキャッシュし、自動復元トグルを提供。
   - 容量上限を考慮し、保存前後でサイズ表示。

### 4.2 PDF出力機能
1. **レイアウト設計**
   - ページ構成: 表紙 / サマリー / 予約分析 / アンケート / リスティング / 相関 / 付録。
   - 各セクションで画面コンポーネントから取得すべきデータと図版の優先度を整理。
2. **描画手段の選定**
   - `html2canvas` で既存 DOM をキャプチャするパターンと、PDF 専用 React コンポーネントで再描画するパターンを比較。
   - 画質・テキスト検索性・処理時間を評価し、結果により採用方針確定。
3. **実装**
   - `hooks/usePdfExport` (新規) で生成処理を共通化。ローディング状態とエラーハンドリングを内包。
   - グラフキャプチャ時はチャート再レンダリング待機を `await new Promise(requestAnimationFrame)` などで調整。
   - 出力オプション（セクション選択、カラー/モノクロ、ページ向き）を引数で制御。
4. **UI 連携**
   - ヘッダーに「PDFレポート出力」ボタン追加。クリックで設定モーダル → 生成開始。
   - 進捗表示（スピナー + ステップ名）と完了通知を実装。
5. **クオリティ調整**
   - 画像圧縮・フォント埋め込みの検証、A4 想定で余白/改ページを調整。
   - 拡張: コメント欄やハイライト日の注釈表示の余地を残す。

### 4.3 周辺改修
1. **データステータス更新**
   - `DataStatusSummary` に保存状態アイコンや PDF 利用可否（必須データ揃っているか）を表示。
2. **Help ドキュメント**
   - 新機能の操作説明、ファイル管理注意事項、PDF 出力の制限事項を追記。
3. **エラーメッセージ整備**
   - 保存/復元/PDF 各処理の失敗時メッセージテンプレートを定義。
4. **CSS/デザイン**
   - 新ボタンやモーダルのスタイルを既存トーン（角丸、シャドウ、青系アクセント）に合わせる。

## 5. テスト計画
- **ユニットテスト**: エクスポート用ユーティリティ、PDF オプション設定、JSON 復元検証ロジック。
- **結合テスト**: 6種類の CSV＋保存済み JSON を使い、月切替から PDF 生成までの一連の操作を手作業で確認。
- **回帰チェック**: 既存ビューの表示・相関分析が壊れていないかを `npm run dev` 上で目視。
- **パフォーマンステスト**: 大容量 CSV（1万行規模）で保存/復元/PDF 生成時間を計測し、目標値（保存 <3s, PDF <10s）を満たすか確認。

## 6. スケジュールとリスク
- 想定工数: 8 日 (設計 1.5 / 保存 2 / PDF 3 / 調整 1.5) + バッファ 1 日。
- 主なリスク:
  - PDF 画質とファイルサイズの両立 → ライブラリ選定時に PoC で解消。
  - ブラウザメモリ制約 → 分割処理・ストリーム書き込みで対処。
  - CSV 仕様変更 → 解析ロジックとテンプレートを同時アップデート。

## 7. 完了判定
- JSON/CSV 保存と復元が UI から操作でき、再読み込み後にグラフが同一結果を示す。
- PDF が指定セクション・オプションを反映し、画質とレイアウトがレビュー承認を得る。
- Help ドキュメントが更新され、ユーザーと運用チームが新フローを理解できる。
- main ブランチへマージ可能な状態でデプロイ準備が整う。
