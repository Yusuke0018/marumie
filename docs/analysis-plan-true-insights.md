# 追加分析実装計画（LTV・エリア施策・時間帯ROAS）

## 0. サマリー
- 対象:  
  1. **分析 #3** 真の初診ベース「新規→継続」価値可視化（患者分析ページ）  
  2. **分析 #7** エリア別チャネル寄与インサイト（マップ分析ページ）  
  3. **分析 #9** 時間帯別 ROAS / CAC の算定（リスティング分析ページ）
- 方針: 既存 UI トーンを崩さずカード＋ミニグラフ＋テキスト評価を配置。重い計算はメモ化し、CSV再読込時に再計算。
- 開発順序: ①データ整形ユーティリティ → ②患者分析 → ③マップ分析 → ④リスティング分析 → ⑤共通ドキュメント/検証。

---

## 1. 分析 #3 新規患者 LTV / 継続分析（患者分析ページ）

### 目的と成果物
- 真の初診（氏名突合済み）を起点に、月次継続率・累積来院点数（概算売上）を可視化。
- 診療科タブの下に「新規患者価値インサイト」カードを追加し、下部にミニコホートグラフと数値テーブル。

### データ/計算
- 入力: `karteRecords`（点数・診療科・日付）、`trueFirstAggregation`（予約側の初診日時）。
- 手順:
  1. `src/lib/correlationData.ts` で整備済みの `buildTrueFirstAggregation` を拡張し、初回診療日と患者キーを返すヘルパーを追加。
  2. カルテ点数から `patientId -> [visitDate, department, points]` を月次集約。
  3. コホート（初診月）単位の継続率（12ヶ月まで）、平均点数、累積点数を計算。
  4. 診療科別サマリ（総合診療/内科/発熱/その他）で LTV 上位順にカード表示。

### UI/UX
- 「診療科別平均単価」の直下に新しいセクションを追加:  
  - ヘッダ：`📈 新規患者価値インサイト`  
  - 3枚カード（初診月 LTV, 3ヶ月継続率, 離脱ハザードの注意喚起）
  - 折りたたみ式で詳細表（コホート別継続率・LTV）と簡易折れ線グラフを表示。
- インタラクション: 診療科タブの切替で値も切替。デフォルト表示は総合診療。
- パフォーマンス: 計算結果は `useMemo` + サマリキャッシュで保持。

### 実装タスク
1. `src/lib/correlationData.ts`：患者キーと初診 ISO を返す API を追加。
2. 新ユーティリティ `aggregatePatientLtv.ts`（新規）でコホート集計ロジックを実装。
3. UIコンポーネント `NewPatientValueSection.tsx` を `src/components/patients/` に追加し、既存ページから読み込み。
4. 既存ストア/コンテキストに依存する場合は `useMemo` でデータ取得、エラー時は無表示。

### 検証
- サンプル CSV で 12ヶ月未満のデータでもクラッシュしないこと。
- カルテ点数が欠損の患者は件数のみ反映し、点数は 0 として扱う。
- UI崩れがないかをデスクトップ/タブレット幅で確認。

---

## 2. 分析 #7 エリア別チャネル寄与インサイト（マップ分析ページ）

### 目的と成果物
- 地図上の地区カードに「Google流入比」「リスティングCV比」「真の初診比率」を重ね、エリアの優先度を評価。
- マップの右側サイドバーに「エリア貢献ランキング」タブを追加（デフォルトは従来グラフ、切替でチャネル分析表示）。

### データ/計算
- 入力: `surveyAggregation`（fever/general）、`listingAggregation`、`trueFirstAggregation`、地図集計済み `karteRecords`.
- 手順:
  1. 地区ごとの来院件数・真の初診件数を `GeoDistributionMap` ですでに算出している値と突合。
  2. 同日・同地区の Google アンケート比率、listing CV 件数（一般/発熱）を集計。
  3. 指標例:  
     - Google貢献スコア = (Google回答 / 真の初診) × 重み  
     - Listing貢献スコア = (エリア該当CV / 真の初診)  
     - 戦略優先度 = 貢献スコア - 真の初診シェア差分
  4. スコアに基づきランキングを作成し、サイドバーに表示。

### UI/UX
- 「ランキングカード」ラジオボタンに `チャネル寄与` 項目を追加。選択時、上位10地区をリスト表示。
- リスト項目: 地区名、Google比率、Listing比率、真の初診件数、推奨コメント。
- 地図マーカーをホバーした際、ツールチップ下部にチャネル比率を追加（色付きバッジで表示）。
- 小画面ではサイドバーを折りたたみ可能にし、タブで切替。

### 実装タスク
1. `GeoDistributionMap.tsx` 内部で必要データを取得するため `buildGeoChannelInsights`（新規ユーティリティ）を導入。
2. サイドバーに新しい `ChannelContributionPanel` コンポーネントを追加。
3. ツールチップ描画ロジックを拡張し、チャネル比率バッジを追加。
4. 既存ランキングタブとの切替状態をステートに追加し、モバイルモードでアクセシビリティを確保。

### 検証
- データ欠損地区（Google比率0%等）でも表示崩れがないこと。
- ランキング切替時の再計算が体感1秒以内に収まるか確認。
- 画面幅 < 768pxでタブ切替が操作しやすいか確認。

---

## 3. 分析 #9 時間帯別 ROAS / CAC（リスティング分析ページ）

### 目的と成果物
- リスティングカテゴリごとに、推定真の初診数（予約・カルテ突合）を基に時間帯別 ROAS / CAC を算出。
- 既存上部カード群の下に「時間帯パフォーマンス」セクションを追加し、ヒートマップ＋トップ3/ワースト3カード表示。

### データ/計算
- 入力: `listingCategoryData`, `trueFirstAggregation`, `reservations`.
- 手順:
  1. 指定カテゴリ（内科/発熱外来など）の CV 金額（cost）を時間帯別に算出。コストは `amount`（広告費）を時間帯配分（CV比例 or 均等）で割る。
  2. 真の初診件数を `bookingHour` ベースで時間帯集計し、ラグ補正（ピークラグ）を考慮して対応する時間帯へシフト。
  3. CAC = 広告費 / 真の初診件数（0除算対策あり）、ROAS = (概算売上: LTV×シェア) / 広告費。
  4. LTVは分析 #3 の診療科別平均点数を流用（デフォルトは最新月の平均点数×10円）。

### UI/UX
- 「時間帯パフォーマンス」セクション構成:
  - KPIカード：最良時間帯のROAS、最良時間帯のCAC、要改善時間帯
  - ヒートマップ（X=時間帯、Y=曜日 or 全体、色=ROAS）＋ツールチップに詳細表示
  - 折りたたみ式テーブル：時間帯ごとの広告費・真の初診数・ROAS/CAC
  - 注記: 推定ロジック（ラグ補正・LTV算出）を小さなヘルプテキストで表示
- カテゴリ切替（既存のプルダウン）に連動して値更新。

### 実装タスク
1. 新ユーティリティ `computeTimebandRoas.ts` を `src/lib/` に追加し、必要な指標をまとめて返す。
2. リスティングページに `TimebandPerformanceSection.tsx` を追加し、既存のカード下に配置。
3. 既存の状態管理（期間フィルタ等）にフックし、メモ化で再計算コストを最小化。
4. ヒートマップは `Recharts` の `ScatterChart` × カスタムセルもしくは `ResponsiveHeatmap`（軽量コンポーネント）を利用。

### 検証
- 真の初診が0の時間帯は CAC/ROAS を `—` 表示。
- ラグ補正が正しく適用されているか（既存ピークラグを参照）。
- 期間フィルタを変えても UI が崩れず、計算結果が更新されるか確認。

---

## 4. 共通事項

1. **型/ストア拡張**
   - 新規ユーティリティの結果型を `src/types/analytics.ts`（新設）に整理。
2. **パフォーマンス**
   - heavy 計算は `useMemo` + 依存配列で管理、デバッグログは最小限。
3. **アクセスビリティ**
   - ツールチップやカードには代替テキスト、折りたたみには `aria-expanded` を付与。
4. **ドキュメント更新**
   - `docs/30_coding-rules.md` → 新ユーティリティの利用指針追記（名前正規化など）。
   - `docs/20_spec.md` → カード追加の仕様反映。
   - `docs/70_changelog.md` → 機能追加を記録。
5. **検証フロー**
   - `npm run lint`, `npm run typecheck`, `npm run build` を必ず通し、主要画面を手動チェック。
   - CSV 再読み込みで計算がリセットされるか確認。

---

## 5. 次のアクション
1. `buildTrueFirstAggregation` 拡張 → `aggregatePatientLtv` と `computeTimebandRoas` のユーティリティ実装。
2. 患者分析ページに LTV セクションを組み込み、UI調整。
3. マップ分析にチャネル寄与タブを追加し、ランキング表示。
4. リスティングページで時間帯パフォーマンスセクションを追加。
5. テスト＆ドキュメント更新 → main へ反映。

以上をガイドラインとして実装を進める。
